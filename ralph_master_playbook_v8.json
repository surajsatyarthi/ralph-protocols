{
  "protocol": {
    "name": "Ralph Master Playbook",
    "version": "13.0.0",
    "effective_date": "2026-02-21",
    "status": "FINAL",
    "purpose": "Immutable server-side governance with cryptographic proofs. Local Verifier Agent auto-launches for real-time feedback but cannot bypass server-side CI. One-time full baseline retro-audit per project + permanent automatic delta enforcement on any legacy file change.",
    "scope": "All synced projects under surajsatyarthi/ralph-protocols",
    "non_retrospective_default": true,
    "retro_audit_enabled": true,
    "changelog": "v13.0: Added missing G1 (Physical Audit), G4 (Implementation Integrity), G8 (TDD Proof), G11 (Production Verification). Added Node.js runtime check to G0. Fixed gate numbering consistency with RALPH_PROTOCOL.md. All 12 technical gates now enforced."
  },
  "core_principles": [
    "Server-side supremacy: GitHub Rulesets + CI runner is the final authority (untouchable by local agent)",
    "Local Verifier Agent auto-launches on project open as real-time helper only",
    "Cryptographic HMAC proofs required for every gate — forged local files rejected by CI",
    "One-time full baseline retro-audit (user-triggered once per project) + permanent automatic delta on any legacy change",
    "Central GitHub repo as single source of truth with postinstall auto-sync and ingestion",
    "No local bypass possible — merge blocked at GitHub level",
    "All 12 gates must be enforced — gaps in gate coverage are P0 protocol violations"
  ],
  "enforcement_layers": {
    "github_primary": {
      "rulesets": "Protect main/develop/releases/**. Require status check 'Ralph-Gates-Passed'. Require signed commits. Block force-push and bypass. No direct pushes allowed.",
      "ci_workflow": ".github/workflows/ralph-verify.yml — runs full gate suite on GitHub runner, verifies HMAC proofs, uploads artifacts, blocks merge on failure"
    },
    "antigravity_helper": {
      "rules": "Global ~/.gemini/GEMINI.md + per-project .agent/rules/ralph-core.md (auto-loaded)",
      "skills": ".agent/skills/ralph-enforcer/ (one SKILL.md per gate, auto-equipped)",
      "terminal_policy": "Request review for git/npm/db/shell; safe-exec wrapper",
      "verifier_agent": {
        "prompt": "You are Ralph Verifier v13.0. Auto-spawn on project open as helper. Monitor changes and provide real-time feedback. Do NOT allow bypass — final decision is always GitHub CI.",
        "spawn": "Automatic on project open (persistent background)",
        "retro_mode": "one_time_full_baseline + permanent_delta_automatic"
      }
    }
  },
  "proof_system": {
    "method": "HMAC-SHA256",
    "key_source": "git rev-parse HEAD (fallback: RALPH_HMAC_KEY from .env)",
    "artifact_dir": ".ralph/proofs/",
    "legacy_dir": ".ralph/proofs/legacy/",
    "format": "{\"gate\":\"G0\",\"status\":\"passed\",\"data_hash\":\"...\",\"commit_sha\":\"...\",\"hmac\":\"...\",\"timestamp\":\"...\"}",
    "ci_verification": "GitHub runner re-computes HMAC and rejects forged local proofs"
  },
  "retro_audit": {
    "strategy": "one_time_full_baseline_per_project + permanent_delta_automatic",
    "baseline_status": "pending_user_trigger_once_per_project",
    "trigger_command": "run retro-audit full baseline on [path]",
    "permanent_mode": "automatic_delta_on_any_legacy_change_no_manual_trigger",
    "output": "LEGACY_AUDIT_BASELINE.md + per-file signed proofs + prioritized LEGACY_AUDIT_BACKLOG.md",
    "phases": ["pilot", "core", "supporting", "full"]
  },
  "sync_mechanism": {
    "source": "Central GitHub repo surajsatyarthi/ralph-protocols",
    "command": "npm run sync:protocols (runs on postinstall and explicit call)",
    "frequency": "Automatic on npm install / postinstall + explicit sync when protocol updates",
    "action_on_sync": "Pull latest playbook JSON → place in .agent/ → trigger Antigravity ingestion → auto-spawn local Verifier Agent → prepare for one-time baseline retro-audit"
  },
  "gates": {
    "_note": "All 12 technical gates are mandatory and sequential. Gate numbers must match RALPH_PROTOCOL.md. Missing gates are P0 violations.",
    "technical": [
      {
        "id": "G0",
        "name": "Pre-Assignment Dupe Blocker + Environment Pre-Flight",
        "skill": "g0-pre-assign",
        "script": "scripts/gates/gate-0-pre-assign.js",
        "phase": "PRE-WORK",
        "mandatory": true,
        "requires_node": true,
        "node_min_version": "18.0.0",
        "blocking": true,
        "description": "Prevents duplicate work. Validates runtime environment (Node.js ≥18, required env vars, service connectivity). Generates .env-validated.log. BLOCKS all subsequent gates if Node.js not installed or env invalid.",
        "artifacts": ["audit-gate-0-dupe-check.log", ".env-validated.log"],
        "node_check": "node --version must return ≥18.0.0. If Node not installed, gate fails immediately with clear install instructions."
      },
      {
        "id": "G1",
        "name": "Physical Audit & State Verification",
        "skill": "g1-physical-audit",
        "script": "scripts/gates/gate-1-physical-audit.js",
        "phase": "ASSESSMENT",
        "mandatory": true,
        "blocking": true,
        "description": "Coder MUST directly observe current code AND production state before any research or planning. No research without knowing what actually exists. Anchored to git HEAD.",
        "artifacts": ["docs/reports/physical-audit-ENTRY_ID.md"],
        "required_sections": [
          "Git HEAD hash (git rev-parse HEAD)",
          "Current file listing of changed areas",
          "Production state (URL, last deploy, current behavior)",
          "Known issues and anomalies"
        ],
        "minimum_lines": 50,
        "enforcement": "pre-dev hook blocks npm run dev until physical-audit-TASK_ID.md exists"
      },
      {
        "id": "G2",
        "name": "External Research Validation",
        "skill": "g2-research",
        "script": "scripts/gates/gate-2-research.js",
        "phase": "ASSESSMENT",
        "mandatory": true,
        "blocking": true,
        "description": "3+ documented web searches required. MUST happen AFTER G1 (you cannot research effectively without knowing current state). MUST happen BEFORE G3 (you cannot plan without research).",
        "artifacts": ["docs/research/ENTRY_ID-research.md"],
        "artifact_note": "Legacy projects may use audit-gate-0-ENTRY_ID.log at project root. Both are accepted. New projects MUST use docs/research/ path.",
        "required_sections": [
          "Minimum 3 web searches (## Search #N headers)",
          "Minimum 5 source citations",
          "Alternatives Considered section",
          "Key Findings section"
        ],
        "minimum_words": 1000,
        "enforcement": "pre-commit hook blocks commits without research artifact"
      },
      {
        "id": "G3",
        "name": "Scope Validation & Blueprint RFC",
        "skill": "g3-scope",
        "script": "scripts/gates/gate-3-scope.js",
        "phase": "PLANNING",
        "mandatory": true,
        "blocking": true,
        "description": "Implementation plan with Alternatives Considered. CEO/PM approval REQUIRED. No code before approval.",
        "artifacts": ["implementation-plan-ENTRY_ID.md"],
        "required_sections": [
          "Problem Statement",
          "Proposed Solution",
          "Alternatives Considered",
          "Files to Change",
          "Approval signature (APPROVED + name + date)"
        ],
        "enforcement": "pre-commit hook checks for APPROVED signature in plan file"
      },
      {
        "id": "G4",
        "name": "Implementation Integrity",
        "skill": "g4-implementation",
        "script": "scripts/gates/gate-4-implementation.js",
        "phase": "EXECUTION",
        "mandatory": true,
        "blocking": true,
        "description": "Verifies actual code changes match the approved G3 plan. Blocks scope creep (>30% unplanned files). Requires commits on branch.",
        "artifacts": ["implementation-plan-ENTRY_ID.md (updated with implementation log)"],
        "scope_creep_threshold": "30% unplanned files triggers violation",
        "enforcement": "runs during implementation, verified at pre-commit"
      },
      {
        "id": "G5",
        "name": "Strict Lint Suppression Check",
        "skill": "g5-lint-strict",
        "script": "scripts/gates/gate-5-lint-strict.js",
        "phase": "EXECUTION",
        "mandatory": true,
        "blocking": true,
        "description": "Bans all lint suppression comments (eslint-disable, @ts-ignore, @ts-nocheck) without documented justification. Zero-tolerance for unexplained suppressions.",
        "enforcement": "scans all changed files for suppression patterns"
      },
      {
        "id": "G6",
        "name": "Test Quality Analysis",
        "skill": "g6-test-quality",
        "script": "scripts/gates/gate-6-test-quality.js",
        "phase": "EXECUTION",
        "mandatory": true,
        "blocking": true,
        "description": "Tests must have adequate assertion density (≥3 per test), real integration tests (not all mocked), and no coverage regression.",
        "enforcement": "analyzes test files for assertion count and mock ratio"
      },
      {
        "id": "G7",
        "name": "Security Suite",
        "skill": "g7-security",
        "script": "scripts/gates/gate-7-security.js",
        "phase": "EXECUTION",
        "mandatory": true,
        "blocking": true,
        "description": "Secrets detection (gitleaks + regex fallback), dependency vulnerability scan (npm audit), OWASP checklist verification.",
        "enforcement": "blocks on any detected secrets or critical/high CVEs"
      },
      {
        "id": "G8",
        "name": "TDD Proof (Test-Driven Development)",
        "skill": "g8-tdd",
        "script": "scripts/gates/gate-8-tdd.js",
        "phase": "EXECUTION",
        "mandatory": true,
        "blocking": true,
        "description": "Tests must exist, pass, and achieve ≥80% coverage. New source files must have corresponding test files. Failing tests = blocked.",
        "artifacts": ["docs/reports/test-results-ENTRY_ID.md"],
        "coverage_minimum": 80,
        "enforcement": "runs npm test, parses coverage, checks new files have tests"
      },
      {
        "id": "G9",
        "name": "Accessibility Validation",
        "skill": "g9-accessibility",
        "script": "scripts/gates/gate-9-accessibility.js",
        "phase": "EXECUTION",
        "mandatory": true,
        "can_skip_condition": "No UI changes (backend-only task)",
        "blocking": true,
        "description": "Axe scan, keyboard navigation, ARIA labels. WCAG 2.1 AA minimum.",
        "enforcement": "axe-core scan on all changed UI components"
      },
      {
        "id": "G10",
        "name": "Performance (Lighthouse ≥80)",
        "skill": "g10-performance",
        "script": "scripts/gates/gate-10-performance.js",
        "phase": "VERIFICATION",
        "mandatory": true,
        "blocking": true,
        "description": "Lighthouse performance score ≥80 (median of 3 runs). Bundle size must not regress by >10%.",
        "minimum_score": 80,
        "enforcement": "lighthouse CI run against staging URL"
      },
      {
        "id": "G11",
        "name": "Production Verification",
        "skill": "g11-production",
        "script": "scripts/gates/gate-11-production.js",
        "phase": "VERIFICATION",
        "mandatory": true,
        "blocking": true,
        "description": "Production must be live, healthy (HTTP 200), and deployment must match expected git commit. Screenshot evidence required. Monitoring for 24h.",
        "artifacts": ["docs/reports/production-verification-ENTRY_ID.md"],
        "required_sections": [
          "Deployment Timestamp",
          "Deployment ID",
          "Production URL (must return HTTP 200)",
          "Screenshot evidence path",
          "Health check results"
        ],
        "monitoring": "hour_0 + hour_6 + hour_24 verification",
        "enforcement": "HTTP ping of production URL + screenshot file existence check"
      },
      {
        "id": "G12",
        "name": "Documentation Completeness",
        "skill": "g12-validate",
        "script": "scripts/gates/gate-12-validate.js",
        "phase": "DOCUMENTATION",
        "mandatory": true,
        "blocking": true,
        "description": "Walkthrough document required. Must cover: what changed, why, how to use, rollback procedure. MASTER_TASK_LIST.md must be updated.",
        "artifacts": ["docs/walkthroughs/walkthrough-ENTRY_ID.md"],
        "enforcement": "file existence + required sections check"
      }
    ],
    "pm_strategic": [
      {"id": "PM-G1", "name": "User Research Validation", "skill": "pm-g1-user-research"},
      {"id": "PM-G2", "name": "PRD Quality Validation", "skill": "pm-g2-prd"},
      {"id": "PM-G3", "name": "Technical Feasibility", "skill": "pm-g3-feasibility"},
      {"id": "PM-G6", "name": "Atomic Ledger Approval", "skill": "pm-g6-approve"}
    ]
  },
  "gate_sequence_rule": "Gates must be executed in order G0 → G1 → G2 → G3 → G4 → G5 → G6 → G7 → G8 → G9 → G10 → G11 → G12. Skipping any gate is a P0 violation. G1 must precede G2 (observe before researching). G2 must precede G3 (research before planning). G3 must precede G4 (plan before coding).",
  "critical_sequence_note": "G1 (Physical Audit) MUST come before G2 (Research). You cannot conduct meaningful research without first directly observing what currently exists in the codebase and production. This is non-negotiable.",
  "best_practices": {
    "server_side_supremacy": "GitHub CI is the final untouchable judge — local agent cannot bypass",
    "auto_launch_helper": "Local Verifier Agent auto-spawns on project open for real-time feedback",
    "evidence_based": "Only HMAC cryptographic proofs accepted by CI",
    "defense_in_depth": true,
    "least_privilege_terminal": true,
    "all_gates_enforced": "Every gate from G0 to G12 has a corresponding script. Missing gate scripts are P0 violations."
  },
  "clarification_questions_resolved": [
    {"question": "Auto-launch Ralph?", "answer": "Local helper auto-spawns; real enforcement is server-side GitHub CI"},
    {"question": "Evidence based?", "answer": "Yes — cryptographic HMAC proofs verified by CI runner"},
    {"question": "Retro-analysis automatic?", "answer": "One-time full baseline (triggered once per project) + permanent automatic delta on any legacy change"},
    {"question": "Why was G1 missing?", "answer": "Bug in v12 — Physical Audit was dropped from master playbook. Fixed in v13. G1 is now mandatory and mechanically enforced."},
    {"question": "Does research (G2) come before planning (G3)?", "answer": "YES. G2 (Research) is ALWAYS before G3 (Planning) which is ALWAYS before G4 (Code). This is the correct and enforced order."},
    {"question": "What if Node.js is not installed?", "answer": "G0 fails immediately with clear error message and install instructions. No other gates can run. This was previously undetected — fixed in v13."}
  ],
  "references": [
    "https://codelabs.developers.google.com/getting-started-with-antigravity-skills",
    "https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-rulesets/about-rulesets",
    "https://www.knostic.ai/blog/ai-coding-agent-security",
    "https://www.techtarget.com/searchsoftwarequality/tip/Guidelines-for-AI-driven-legacy-code-modernization"
  ]
}
