name: Protocol Gate Enforcement

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  # Gate 5: Strict Lint Check
  lint-enforcement:
    name: Gate 5 - Lint Suppression Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit for comparison
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Lint Strict Check
        run: npm run lint:strict -- ${{ github.event.pull_request.head.ref || 'ENTRY-000' }}
        continue-on-error: false

  # Gate 7: Security Suite
  security-gate:
    name: Gate 7 - Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install gitleaks
        run: |
          wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/
          gitleaks version
      
      - name: Run Security Gate
        run: npm run security:gate -- ${{ github.event.pull_request.head.ref || 'ENTRY-000' }}
        continue-on-error: false

  # Gate 6: Test Quality Analysis
  test-quality:
    name: Gate 6 - Test Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Test Quality Analysis
        run: npm run analyze:tests -- ${{ github.event.pull_request.head.ref || 'ENTRY-000' }}
        continue-on-error: false
      
      - name: Upload Test Quality Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-quality-report
          path: .evidence/reports/test-quality-*.json

  # Gate 9: Accessibility Check
  accessibility-gate:
    name: Gate 9 - Accessibility
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright
        run: npx playwright install --with-deps chromium
      
      - name: Start dev server
        run: npm run dev &
        env:
          CI: true
      
      - name: Wait for server
        run: npx wait-on http://localhost:3000 --timeout 60000
      
      - name: Run Accessibility Gate
        run: npm run a11y:gate -- ${{ github.event.pull_request.head.ref || 'ENTRY-000' }} http://localhost:3000
        continue-on-error: false
      
      - name: Upload Accessibility Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report
          path: .evidence/reports/accessibility-*.json

  # Evidence Collection
  collect-evidence:
    name: Collect Evidence Tickets
    runs-on: ubuntu-latest
    needs: [lint-enforcement, security-gate, test-quality, accessibility-gate]
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: List evidence
        run: |
          echo "## Evidence Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d ".evidence/tickets" ]; then
            echo "### Evidence Tickets:" >> $GITHUB_STEP_SUMMARY
            ls -la .evidence/tickets/ >> $GITHUB_STEP_SUMMARY || echo "No tickets found" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -d ".evidence/reports" ]; then
            echo "### Evidence Reports:" >> $GITHUB_STEP_SUMMARY
            ls -la .evidence/reports/ >> $GITHUB_STEP_SUMMARY || echo "No reports found" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload all evidence
        uses: actions/upload-artifact@v4
        with:
          name: gate-evidence-${{ github.sha }}
          path: |
            .evidence/tickets/
            .evidence/reports/
          retention-days: 90

  # Summary
  gate-summary:
    name: Gate Enforcement Summary
    runs-on: ubuntu-latest
    needs: [lint-enforcement, security-gate, test-quality, accessibility-gate]
    if: always()
    steps:
      - name: Create Summary
        run: |
          echo "# ðŸ”’ Protocol Gate Enforcement Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Gate | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Gate 5 - Lint Suppression | ${{ needs.lint-enforcement.result == 'success' && 'âœ… PASSED' || 'âŒ BLOCKED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gate 7 - Security Scan | ${{ needs.security-gate.result == 'success' && 'âœ… PASSED' || 'âŒ BLOCKED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gate 6 - Test Quality | ${{ needs.test-quality.result == 'success' && 'âœ… PASSED' || 'âŒ BLOCKED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gate 9 - Accessibility | ${{ needs.accessibility-gate.result == 'success' && 'âœ… PASSED' || 'âŒ BLOCKED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.lint-enforcement.result }}" == "success" ]] && \
             [[ "${{ needs.security-gate.result }}" == "success" ]] && \
             [[ "${{ needs.test-quality.result }}" == "success" ]] && \
             [[ "${{ needs.accessibility-gate.result }}" == "success" ]]; then
            echo "## âœ… All Gates Passed" >> $GITHUB_STEP_SUMMARY
            echo "This PR meets protocol enforcement standards." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Gate Enforcement Failed" >> $GITHUB_STEP_SUMMARY
            echo "This PR is blocked by protocol gates. Review the failed checks above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
